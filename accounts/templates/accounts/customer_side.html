{% extends 'layouts/base.html' %}
{% load static %}
{% load custom_filters %}
{% block title %}Game Boosters{% endblock %}
{% block style %}
<link rel="stylesheet" href="{% static 'accounts/css/customer_order.css' %}">
{% endblock %}
{% block container %}
<div class="containter-fluid customer-order-body py-5">
  <div class="container py-5 customer-order text-white">
    <div class="row justify-content-between ">

      <div class="col-3 information shadow p-5 text-center">

        <div class="user-info">
          <img src="{{ request.user.image.url }}" class="profile-image col-4" alt="profile" />
          <h4 class="my-3">{{request.user.first_name}} {{request.user.last_name}}</h4>
          <a href="{% url 'accounts.profile' %}" class="fs-5" style="color: var(--secondary-color)">My Profile
            &rarr;</a>
        </div>
        <hr>

        <div class="order-info my-4">
          <div class="from row">
            <p class="my-3 text-uppercase col-4 px-0">From</p>
            <img class="text-center col-4 px-0" src="{{order.current_rank.get_image_url}}" width="70" height="70" />
            <p class="my-3 text-uppercase col-4 px-0">{{order.current_rank}} {{ order.current_division|romanize_division }}</p>
          </div>

          <i class="fa-solid fa-angle-down my-3" style="color: var(--secondary-color);"></i>

          <div class="current row">
            <p class="my-3 text-uppercase col-4 px-0">Current</p>
            <img class="text-center col-4 px-0" src="{{order.reached_rank.get_image_url}}" width="70" height="70" />
            <p class="my-3 text-uppercase col-4 px-0">{{order.reached_rank}} {{ order.reached_division|romanize_division }}</p>
          </div>

          <i class="fa-solid fa-angle-down my-3" style="color: var(--secondary-color);"></i>

          <div class="to row">
            <p class="my-3 text-uppercase col-4 px-0">TO</p>
            <img class="text-center col-4 px-0" src="{{order.desired_rank.get_image_url}}" width="70" height="70" />
            <p class="my-3 text-uppercase col-4 px-0">{{order.desired_rank}} {{ order.desired_division|romanize_division }}</p>
          </div>
        </div>

        {% if not order.customer_gamename and not order.customer_password and not order.customer_server %}
        <hr>

        <div class="game-data">
          <form action="{% url 'set.customer.data' %}" method="POST">
            {% csrf_token %}
            {% if error %} <p class="text-danger">{{error}}</p> {% endif %}
            <input type="hidden" name="order_id" value="{{ order.id }}">
            <input type="hidden" name="slug" value="{{ slug }}">
            <div class="input-group mb-3">
              <span class="input-group-text" id="basic-addon1">@</span>
              <input type="text" required name="gamename" class="form-control" placeholder="Username"
                aria-label="Username" aria-describedby="basic-addon1">
            </div>

            <div class="input-group mb-3">
              <label class="input-group-text my-0" for="inputGroupSelect01"
                style="margin: 0 !important;">Servers</label>
              <select class="form-select" required name="server" id="inputGroupSelect01">
                <option value="1" selected>Europa</option>
                <option value="2">America</option>
                <option value="3">Asia</option>
                <option value="4">Africa</option>
                <option value="5">Australia</option>
              </select>
            </div>

            {% if not order.duo_boosting %}
            <div class="input-group mb-3">
              <span class="input-group-text" id="basic-addon1">*</span>
              <input type="password" required name="password" class="form-control" placeholder="Password"
                aria-label="Password" aria-describedby="basic-addon1">
            </div>
            {% endif %}

            <div class="text-end">
              <button type="submit" class="btn submit-btn">Submit</button>
            </div>
          </form>
        </div>
        {% endif %}

      </div>

      <div class="col-8">
        {% if order.booster is null %}
        {% if order.select_booster %}
        <h4 id="choose-booster">Choose Booster</h4>
        <div class="choose-booster p-5 mb-5">
          {% for booster in boosters %}
          {% if booster != user %}
          <div class="booster mb-4 d-flex justify-content-between align-items-center ">
            <div class="data">
              <img src="{{ booster.image.url }}" alt="profile" width="50" style="border-radius: 50%;" />
              <span class="ms-4">{{booster.first_name}} {{booster.last_name}}</span>
            </div>

            <form action="{% url 'choose.booster' %}" method="POST">
              {% csrf_token %}
              <input type="hidden" name="chosen_booster_id" value="{{ booster.id }}">
              <input type="hidden" name="order_id" value="{{ order.id }}">
              <input type="hidden" name="slug" value="{{ slug }}">
              <button type="submit" class="btn submit-btn">Choose</button>
            </form>
          </div>
          {% endif %}
          {% endfor %}
        </div>
        {% else %}
        <p><i class="fa-regular fa-clock"></i> Wait For Booster ...</p>
        {% endif %}
        {% else %}
        <h4 id="chat-booster">Chat With Booster</h4>
        <div class="chat-booster mb-5">
          <div class="container mt-5 pt-5 messages-section">
            <div class="row d-flex justify-content-center">
              <div class="col-12">
                <div class="btn messages-Header">
                  <h5>ROOM :- {{room_name}}</h5>
                </div>
                <form>
                  <div class="form-group px-4 py-2">
                    {% if messages %}
                    <div class="chatbox" id="chatbox" style="padding: 4px 2px;max-height: 300px; overflow-y: scroll;">
                      {% for message in messages %}
                      <div
                        class="chat-message {% if message.user == request.user %} userMessage {% else %} otherMessage {% endif %}">
                        <b>{{ message.user.username }}</b> : {{ message.content }}<br>
                      </div>
                      {% endfor %}
                    </div>
                    {% else %}
                    <div class="chatbox" id="chatbox" style="padding: 4px 2px;"></div>
                    <b>No Messages in this Room.</b>
                    {% endif %}
                  </div>
                  {% if room.active %}
                  <div class="form-group d-flex justify-content-center mx-4 mt-2">
                    <input class="form-control" style="width: 80%;" placeholder="Enter text here" id="my_input" type="text"
                      required>
                    <input class="btn sendButton mx-3" id="submit_button" type="button" value="Send">
                  </div>
                  {% else %}
                  <div class="chatbox fw-bold" id="chatbox" style="margin-top: 2rem;">
                    <div class="chat-message text-center">
                      Closed Chat
                    </div>
                  </div>
                  {% endif %}
                </form>
              </div>
            </div>
          </div>
        </div>
        {% endif %}
        <h4 id="chat-admin">Chat With Admin</h4>
        <div class="chat-admin"></div>
      </div>
    </div>
  </div>
</div>
<div>
  {{slug|json_script:"room_slug"}}
</div>
{% endblock %}
{% block script %}
<script>

  const chatbox = document.querySelector("#chatbox");

  // Function to scroll to the bottom of the chatbox
  function scrollToBottom() {
    chatbox.scrollTop = chatbox.scrollHeight;
  }

  // Scroll to bottom when the page is loaded
  scrollToBottom();


  const roomName = JSON.parse(document.getElementById('room_slug').textContent);
  const chatSocket = new WebSocket("ws://" + window.location.host + "/ws/" + roomName + "/");
  // const chatSocket = new WebSocket("ws://127.0.0.1:8000/ws/"+ roomName +"/");
  // alert(chatSocket);
  chatSocket.onopen = function (e) {
    console.log("The connection was setup successfully !");
  };
  chatSocket.onclose = function (e) {
    console.log("Something unexpected happened !");
  };

  document.querySelector("#my_input").focus();
  document.querySelector("#my_input").onkeyup = function (e) {
    if (e.keyCode == 13) {
      e.preventDefault();
      document.querySelector("#submit_button").click();
    }
  };
  document.querySelector("#submit_button").onclick = function (e) {
    var messageInput = document.querySelector(
      "#my_input"
    ).value;

    if (messageInput.length == 0) {
      alert("Add some Input First Or Press Send Button!")
    }
    else {
      chatSocket.send(JSON.stringify({ message: messageInput, username: "{{request.user.username}}", room_name: "{{room.name}}" }));


    }

  };

  chatSocket.onmessage = function (e) {
    const data = JSON.parse(e.data);
    var div = document.createElement("div");
    div.innerHTML = "<b>" + data.username + "</b> : " + data.message;

    // Add class based on user authentication
    if (data.username === "{{ request.user.username }}") {
      div.classList.add("chat-message", "userMessage");
    } else {
      div.classList.add("chat-message", "otherMessage");
    }

    document.querySelector("#my_input").value = "";
    document.querySelector("#chatbox").appendChild(div);
    scrollToBottom();
  };
</script>
{% endblock %}