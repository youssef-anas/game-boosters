<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Realtime Notifications Test</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">
  <div class="max-w-4xl mx-auto py-8">
    <h1 class="text-2xl font-bold mb-4">ðŸ”” Realtime Notifications Test</h1>

    <div class="bg-white p-4 rounded shadow mb-4 flex items-center justify-between">
      <div>
        <div class="text-sm text-gray-500">Role</div>
        <div id="role" class="font-mono text-gray-900">{{ role }}</div>
      </div>
      <div class="flex items-center gap-2">
        <div id="statusDot" class="w-3 h-3 rounded-full bg-red-500"></div>
        <div id="statusText" class="text-sm text-gray-700">Disconnected</div>
      </div>
    </div>

    <div id="toast" class="hidden fixed top-4 right-4 bg-blue-600 text-white px-4 py-2 rounded shadow"></div>

    <div class="bg-white p-4 rounded shadow mb-4">
      <div class="text-sm text-gray-500 mb-2">WebSocket URL</div>
      <code id="wsUrl" class="block p-2 bg-gray-100 rounded text-sm"></code>
      <div class="mt-3 flex gap-2">
        <button id="btnConnect" class="px-3 py-2 bg-green-600 text-white rounded">Connect</button>
        <button id="btnDisconnect" class="px-3 py-2 bg-gray-600 text-white rounded">Disconnect</button>
      </div>
    </div>

    <div class="bg-white p-4 rounded shadow">
      <div class="text-sm text-gray-500 mb-2">Event Log</div>
      <pre id="log" class="h-64 overflow-auto bg-gray-50 p-3 rounded text-sm"></pre>
    </div>
  </div>

  <script>
    const role = '{{ role }}';
    const wsProtocol = '{{ ws_protocol }}';
    const host = '{{ host }}';
    const wsPath = `${wsProtocol}://${host}/ws/notifications/${role}/`;

    const wsUrlEl = document.getElementById('wsUrl');
    const statusDot = document.getElementById('statusDot');
    const statusText = document.getElementById('statusText');
    const toast = document.getElementById('toast');
    const log = document.getElementById('log');
    const btnConnect = document.getElementById('btnConnect');
    const btnDisconnect = document.getElementById('btnDisconnect');

    wsUrlEl.textContent = wsPath;

    let ws = null;
    let reconnectAttempts = 0;
    const maxReconnect = 5;

    function setConnected(connected) {
      statusDot.className = `w-3 h-3 rounded-full ${connected ? 'bg-green-500' : 'bg-red-500'}`;
      statusText.textContent = connected ? 'Connected' : 'Disconnected';
    }

    function showToast(text) {
      toast.textContent = text;
      toast.classList.remove('hidden');
      setTimeout(() => toast.classList.add('hidden'), 2000);
    }

    function logLine(obj) {
      const line = typeof obj === 'string' ? obj : JSON.stringify(obj);
      log.textContent += `\n${new Date().toISOString()} ${line}`;
      log.scrollTop = log.scrollHeight;
    }

    function connect() {
      if (ws) ws.close();
      ws = new WebSocket(wsPath);
      ws.onopen = () => {
        setConnected(true);
        reconnectAttempts = 0;
        logLine('Connected');
      };
      ws.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          logLine(data);
          if (data && data.type === 'notification') {
            const title = data.title || 'Notification';
            const msg = data.message || '';
            showToast(`${title}: ${msg}`);
          }
        } catch (e) {
          logLine(`Invalid JSON: ${event.data}`);
        }
      };
      ws.onclose = () => {
        setConnected(false);
        logLine('Disconnected');
        if (reconnectAttempts < maxReconnect) {
          reconnectAttempts += 1;
          const delay = 500 * reconnectAttempts;
          logLine(`Reconnecting in ${delay}ms (attempt ${reconnectAttempts}/${maxReconnect})...`);
          setTimeout(connect, delay);
        }
      };
      ws.onerror = (e) => {
        logLine('WebSocket error');
      };
    }

    btnConnect.addEventListener('click', connect);
    btnDisconnect.addEventListener('click', () => { if (ws) ws.close(); });

    // Auto-connect on load
    connect();
  </script>
</body>
</html>



