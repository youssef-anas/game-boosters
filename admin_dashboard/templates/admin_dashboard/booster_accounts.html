{% extends "admin/base_site.html" %}
{% load humanize %}
{% load static %}

{% block title %}Booster Accounts Management{% endblock %}

{% block extrahead %}
{{ block.super }}
<style>
.booster-container {
    padding: 20px;
    background: #1a1a1a;
    min-height: 100vh;
}
.booster-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 2px solid #00ff88;
}
.booster-title {
    color: #00ff88;
    font-size: 2em;
    margin: 0;
}
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}
.stat-card {
    background: #2c3e50;
    padding: 20px;
    border-radius: 8px;
    text-align: center;
    color: white;
}
.stat-number {
    font-size: 2em;
    font-weight: bold;
    color: #00ff88;
    display: block;
}
.stat-label {
    color: #bdc3c7;
    margin-top: 5px;
}
.filters-section {
    background: #2c3e50;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 30px;
}
.filter-row {
    display: flex;
    gap: 15px;
    align-items: end;
    flex-wrap: wrap;
}
.filter-group {
    flex: 1;
    min-width: 200px;
}
.filter-group label {
    display: block;
    color: #00ff88;
    margin-bottom: 5px;
    font-weight: bold;
}
.filter-group input,
.filter-group select {
    width: 100%;
    padding: 10px;
    border: 1px solid #34495e;
    border-radius: 4px;
    background: #34495e;
    color: white;
}
.filter-group input:focus,
.filter-group select:focus {
    outline: none;
    border-color: #00ff88;
}
.btn-primary {
    background: #00ff88;
    color: #1a1a1a;
    border: none;
    padding: 10px 20px;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
}
.btn-primary:hover {
    background: #00cc6a;
}
.booster-table {
    background: #2c3e50;
    border-radius: 8px;
    overflow: hidden;
}
.table {
    width: 100%;
    border-collapse: collapse;
    color: white;
}
.table th {
    background: #34495e;
    color: #00ff88;
    padding: 15px;
    text-align: left;
    font-weight: bold;
}
.table td {
    padding: 15px;
    border-bottom: 1px solid #34495e;
}
.table tbody tr:hover {
    background: #34495e;
}
.booster-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
}
.booster-info {
    display: flex;
    align-items: center;
    gap: 10px;
}
.booster-name {
    font-weight: bold;
    color: #00ff88;
}
.booster-email {
    color: #bdc3c7;
    font-size: 0.9em;
}
.status-badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.8em;
    font-weight: bold;
}
.status-active {
    background: #27ae60;
    color: white;
}
.status-inactive {
    background: #e74c3c;
    color: white;
}
.games-list {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
}
.game-tag {
    background: #3498db;
    color: white;
    padding: 2px 6px;
    border-radius: 10px;
    font-size: 0.7em;
}
.earnings-amount {
    color: #f39c12;
    font-weight: bold;
}
.action-buttons {
    display: flex;
    gap: 5px;
}
.btn-sm {
    padding: 5px 10px;
    border: none;
    border-radius: 3px;
    cursor: pointer;
    font-size: 0.8em;
}
.btn-info {
    background: #3498db;
    color: white;
}
.btn-warning {
    background: #f39c12;
    color: white;
}
.btn-danger {
    background: #e74c3c;
    color: white;
}
.btn-success {
    background: #27ae60;
    color: white;
}
.pagination {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-top: 30px;
}
.page-link {
    padding: 10px 15px;
    background: #34495e;
    color: white;
    text-decoration: none;
    border-radius: 4px;
}
.page-link:hover {
    background: #00ff88;
    color: #1a1a1a;
}
.page-current {
    background: #00ff88;
    color: #1a1a1a;
}
</style>
{% endblock %}

{% block content %}
<div class="booster-container">
    <!-- Header -->
    <div class="booster-header">
        <h1 class="booster-title">
            <i class="fas fa-trophy"></i> Booster Accounts Management
        </h1>
        <button class="btn-primary" onclick="addNewBooster()">
            <i class="fas fa-plus"></i> Add New Booster
        </button>
    </div>

    <!-- Statistics -->
    <div class="stats-grid">
        <div class="stat-card">
            <span class="stat-number">{{ total_boosters }}</span>
            <div class="stat-label">Total Boosters</div>
        </div>
        <div class="stat-card">
            <span class="stat-number">{{ active_boosters }}</span>
            <div class="stat-label">Active Boosters</div>
        </div>
        <div class="stat-card">
            <span class="stat-number">${{ total_earnings|floatformat:2 }}</span>
            <div class="stat-label">Total Earnings</div>
        </div>
        <div class="stat-card">
            <span class="stat-number">{{ avg_rating|floatformat:1 }}</span>
            <div class="stat-label">Average Rating</div>
        </div>
    </div>

    <!-- Filters -->
    <div class="filters-section">
        <form method="get" id="booster-filters">
            <div class="filter-row">
                <div class="filter-group">
                    <label>Search</label>
                    <input type="text" name="search" value="{{ request.GET.search }}" placeholder="Username or email">
                </div>
                <div class="filter-group">
                    <label>Game</label>
                    <input type="text" name="game" value="{{ request.GET.game }}" placeholder="Filter by game">
                </div>
                <div class="filter-group">
                    <label>Sort By</label>
                    <select name="sort">
                        <option value="">Default</option>
                        <option value="ongoing" {% if request.GET.sort == 'ongoing' %}selected{% endif %}>Ongoing Jobs</option>
                        <option value="completed" {% if request.GET.sort == 'completed' %}selected{% endif %}>Completed Jobs</option>
                        <option value="earnings" {% if request.GET.sort == 'earnings' %}selected{% endif %}>Lifetime Earnings</option>
                    </select>
                </div>
                <div class="filter-group">
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-search"></i> Apply Filters
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- Boosters Table -->
    <div class="booster-table">
        <table class="table">
            <thead>
                <tr>
                    <th>Booster</th>
                    <th>Contact</th>
                    <th>Games</th>
                    <th>Status</th>
                    <th>Ongoing Jobs</th>
                    <th>Completed Jobs</th>
                    <th>Lifetime Earnings</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for booster in boosters %}
                <tr>
                    <td>
                        <div class="booster-info">
                            {% if booster.profile_image %}
                            <img src="{{ booster.profile_image.url }}" alt="{{ booster.booster.username }}" class="booster-avatar">
                            {% else %}
                            <div class="booster-avatar" style="background: #34495e; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-user"></i>
                            </div>
                            {% endif %}
                            <div>
                                <div class="booster-name">{{ booster.booster.username }}</div>
                                <div class="booster-email">{{ booster.booster.email }}</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div>
                            <div><strong>Discord:</strong> {{ booster.discord_id|default:"Not set" }}</div>
                            <div><strong>PayPal:</strong> {{ booster.paypal_account|default:"Not set" }}</div>
                        </div>
                    </td>
                    <td>
                        <div class="games-list">
                            {% for game in booster.games.all|slice:":3" %}
                            <span class="game-tag">{{ game.name }}</span>
                            {% endfor %}
                            {% if booster.games.count > 3 %}
                            <span class="game-tag">+{{ booster.games.count|add:"-3" }} more</span>
                            {% endif %}
                        </div>
                    </td>
                    <td>
                        <span class="status-badge {% if booster.booster.is_active %}status-active{% else %}status-inactive{% endif %}">
                            {% if booster.booster.is_active %}Active{% else %}Inactive{% endif %}
                        </span>
                    </td>
                    <td>
                        <span class="status-badge" style="background: #f39c12;">{{ booster.ongoing_orders|default:0 }}</span>
                    </td>
                    <td>
                        <span class="status-badge" style="background: #27ae60;">{{ booster.completed_orders|default:0 }}</span>
                    </td>
                    <td>
                        <span class="earnings-amount">${{ booster.lifetime_earnings|default:0|floatformat:2 }}</span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-sm btn-info" onclick="viewBoosterDetails({{ booster.id }})" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn-sm btn-warning" onclick="editBooster({{ booster.id }})" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-sm btn-success" onclick="setCommission({{ booster.id }})" title="Set Commission">
                                <i class="fas fa-percentage"></i>
                            </button>
                            <button class="btn-sm btn-danger" onclick="deleteBooster({{ booster.id }})" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="8" style="text-align: center; padding: 40px; color: #bdc3c7;">
                        <i class="fas fa-users" style="font-size: 3em; margin-bottom: 20px; display: block;"></i>
                        <h3>No boosters found</h3>
                        <p>Try adjusting your search filters or add a new booster.</p>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    {% if is_paginated %}
    <div class="pagination">
        {% if page_obj.has_previous %}
        <a href="?page={{ page_obj.previous_page_number }}&search={{ request.GET.search }}&game={{ request.GET.game }}&sort={{ request.GET.sort }}" class="page-link">
            <i class="fas fa-chevron-left"></i> Previous
        </a>
        {% endif %}
        
        {% for num in page_obj.paginator.page_range %}
        {% if page_obj.number == num %}
        <span class="page-link page-current">{{ num }}</span>
        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
        <a href="?page={{ num }}&search={{ request.GET.search }}&game={{ request.GET.game }}&sort={{ request.GET.sort }}" class="page-link">{{ num }}</a>
        {% endif %}
        {% endfor %}
        
        {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}&search={{ request.GET.search }}&game={{ request.GET.game }}&sort={{ request.GET.sort }}" class="page-link">
            Next <i class="fas fa-chevron-right"></i>
        </a>
        {% endif %}
    </div>
    {% endif %}
</div>

<!-- Custom Booster Details Modal -->
<div id="boosterDetailsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 9999; overflow-y: auto;">
    <div style="position: relative; margin: 2% auto; max-width: 90%; max-height: 90%; background: #2c3e50; border: 2px solid #00ff88; border-radius: 8px; box-shadow: 0 4px 20px rgba(0, 255, 136, 0.3);">
        <div style="background: #34495e; padding: 20px; border-bottom: 2px solid #00ff88; border-radius: 6px 6px 0 0; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="color: #00ff88; margin: 0; font-weight: bold;">Booster Details</h3>
            <button onclick="closeBoosterModal()" style="background: none; border: none; color: white; font-size: 2em; cursor: pointer; padding: 0; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">&times;</button>
        </div>
        <div id="booster-details-content" style="padding: 20px; background: #2c3e50; max-height: 70vh; overflow-y: auto;">
            <!-- Content will be loaded here -->
        </div>
    </div>
</div>

<!-- Custom Commission Modal -->
<div id="commissionModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 9999;">
    <div style="position: relative; margin: 10% auto; max-width: 500px; background: #2c3e50; border: 2px solid #00ff88; border-radius: 8px; box-shadow: 0 4px 20px rgba(0, 255, 136, 0.3);">
        <div style="background: #34495e; padding: 20px; border-bottom: 2px solid #00ff88; border-radius: 6px 6px 0 0; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="color: #00ff88; margin: 0; font-weight: bold;">Set Booster Commission</h3>
            <button onclick="closeCommissionModal()" style="background: none; border: none; color: white; font-size: 2em; cursor: pointer; padding: 0; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">&times;</button>
        </div>
        <div style="padding: 20px; background: #2c3e50;">
            <form id="commissionForm">
                <input type="hidden" id="booster-id">
                <div style="margin-bottom: 20px;">
                    <label style="color: #00ff88; font-weight: bold; display: block; margin-bottom: 8px;">Commission Percentage (%)</label>
                    <input type="number" id="commission-percentage" min="0" max="100" step="0.1" required 
                           style="width: 100%; background: #34495e; border: 1px solid #00ff88; color: white; padding: 12px; border-radius: 4px; font-size: 16px;">
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="color: #00ff88; font-weight: bold; display: block; margin-bottom: 8px;">Notes</label>
                    <textarea id="commission-notes" rows="3" placeholder="Optional notes about this commission rate"
                              style="width: 100%; background: #34495e; border: 1px solid #00ff88; color: white; padding: 12px; border-radius: 4px; font-size: 16px; resize: vertical;"></textarea>
                </div>
            </form>
        </div>
        <div style="background: #34495e; padding: 20px; border-top: 2px solid #00ff88; border-radius: 0 0 6px 6px; display: flex; gap: 10px; justify-content: flex-end;">
            <button onclick="closeCommissionModal()" 
                    style="background: #6c757d; border: none; color: white; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold;">Cancel</button>
            <button onclick="saveCommission()" 
                    style="background: #00ff88; border: none; color: #1a1a1a; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold;">Save Commission</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extrajs %}
{{ block.super }}
<script>
// Booster management functions
function addNewBooster() {
    // Redirect to Django admin for creating new booster
    window.open('/admin/booster/booster/add/', '_blank');
}

function viewBoosterDetails(boosterId) {
    console.log('Loading booster details for ID:', boosterId);
    
    // Show modal immediately
    const modal = document.getElementById('boosterDetailsModal');
    const content = document.getElementById('booster-details-content');
    
    // Show loading state
    content.innerHTML = '<div style="text-align: center; padding: 40px; color: #00ff88; font-size: 18px;">Loading booster details...</div>';
    modal.style.display = 'block';
    
    // Load booster details via AJAX
    fetch(`/admin/dashboard/api/booster/${boosterId}/`)
        .then(response => {
            console.log('Response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Booster data received:', data);
            const modalContent = generateBoosterDetailsHTML(data, boosterId);
            content.innerHTML = modalContent;
        })
        .catch(error => {
            console.error('Error loading booster details:', error);
            content.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #e74c3c;">
                    <h4 style="color: #e74c3c; margin-bottom: 20px;">Error Loading Booster Details</h4>
                    <p style="margin-bottom: 20px;">Could not load booster information. Please try again.</p>
                    <button onclick="viewBoosterDetails(${boosterId})" 
                            style="background: #00ff88; color: #1a1a1a; border: none; padding: 12px 24px; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 16px;">
                        Retry
                    </button>
                </div>
            `;
        });
}

function closeBoosterModal() {
    const modal = document.getElementById('boosterDetailsModal');
    modal.style.display = 'none';
}

function closeCommissionModal() {
    const modal = document.getElementById('commissionModal');
    modal.style.display = 'none';
}

function generateBoosterDetailsHTML(data, boosterId) {
    return `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <div style="background: #34495e; padding: 15px; border-radius: 8px; border: 1px solid #00ff88;">
                <h6 style="color: #00ff88; margin-bottom: 15px; font-weight: bold;">Basic Information</h6>
                <p style="margin: 8px 0; color: white;"><strong style="color: #00ff88;">Username:</strong> ${data.username || 'N/A'}</p>
                <p style="margin: 8px 0; color: white;"><strong style="color: #00ff88;">Email:</strong> ${data.email || 'N/A'}</p>
                <p style="margin: 8px 0; color: white;"><strong style="color: #00ff88;">Discord ID:</strong> ${data.discord_id || 'Not set'}</p>
                <p style="margin: 8px 0; color: white;"><strong style="color: #00ff88;">PayPal:</strong> ${data.paypal_account || 'Not set'}</p>
                <p style="margin: 8px 0; color: white;"><strong style="color: #00ff88;">Status:</strong> 
                    <span style="background: ${data.is_active ? '#27ae60' : '#e74c3c'}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8em;">
                        ${data.is_active ? 'Active' : 'Inactive'}
                    </span>
                </p>
            </div>
            <div style="background: #34495e; padding: 15px; border-radius: 8px; border: 1px solid #00ff88;">
                <h6 style="color: #00ff88; margin-bottom: 15px; font-weight: bold;">Performance Stats</h6>
                <p style="margin: 8px 0; color: white;"><strong style="color: #00ff88;">Ongoing Jobs:</strong> 
                    <span style="background: #f39c12; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8em;">${data.ongoing_orders || 0}</span>
                </p>
                <p style="margin: 8px 0; color: white;"><strong style="color: #00ff88;">Completed Jobs:</strong> 
                    <span style="background: #27ae60; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8em;">${data.completed_orders || 0}</span>
                </p>
                <p style="margin: 8px 0; color: white;"><strong style="color: #00ff88;">Lifetime Earnings:</strong> 
                    <span style="color: #f39c12; font-weight: bold;">$${data.lifetime_earnings || 0}</span>
                </p>
                <p style="margin: 8px 0; color: white;"><strong style="color: #00ff88;">Average Rating:</strong> ${data.avg_rating || 'N/A'}</p>
                <p style="margin: 8px 0; color: white;"><strong style="color: #00ff88;">Current Commission:</strong> 
                    ${data.commission ? 
                        `<span style="background: #f39c12; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8em;">${data.commission.percentage}%</span>` : 
                        '<span style="color: #bdc3c7;">Not set</span>'
                    }
                </p>
            </div>
        </div>
        <div style="background: #34495e; padding: 15px; border-radius: 8px; border: 1px solid #00ff88; margin-bottom: 20px;">
            <h6 style="color: #00ff88; margin-bottom: 15px; font-weight: bold;">Games</h6>
            <div class="games-list">
                ${data.games && data.games.length > 0 ? data.games.map(game => `<span class="game-tag">${game}</span>`).join('') : '<span style="color: #bdc3c7;">No games assigned</span>'}
            </div>
        </div>
        ${data.commission ? `
        <div style="background: #34495e; padding: 15px; border-radius: 8px; border: 1px solid #00ff88; margin-bottom: 20px;">
            <h6 style="color: #00ff88; margin-bottom: 15px; font-weight: bold;">Current Commission Details</h6>
            <div style="background: #2c3e50; padding: 10px; border-radius: 4px; border-left: 3px solid #f39c12;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                    <strong style="color: #f39c12; font-size: 1.1em;">${data.commission.percentage}% Commission</strong>
                    <span style="color: #bdc3c7; font-size: 0.8em;">Set by ${data.commission.set_by}</span>
                </div>
                <p style="color: white; margin: 0; font-size: 0.9em;">${data.commission.notes || 'No notes provided'}</p>
                <p style="color: #bdc3c7; margin: 5px 0 0 0; font-size: 0.8em;">Set on: ${data.commission.created_at}</p>
            </div>
        </div>
        ` : ''}
        <div style="background: #34495e; padding: 15px; border-radius: 8px; border: 1px solid #00ff88;">
            <h6 style="color: #00ff88; margin-bottom: 15px; font-weight: bold;">Admin Comments</h6>
            <div id="admin-comments" style="margin-bottom: 15px; max-height: 200px; overflow-y: auto;">
                ${data.comments && data.comments.length > 0 ? 
                    data.comments.map(comment => `
                        <div style="background: #2c3e50; padding: 10px; margin-bottom: 10px; border-radius: 4px; border-left: 3px solid #00ff88;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                <strong style="color: #00ff88; font-size: 0.9em;">${comment.admin}</strong>
                                <span style="color: #bdc3c7; font-size: 0.8em;">${comment.created_at}</span>
                            </div>
                            <p style="color: white; margin: 0; font-size: 0.9em;">${comment.comment}</p>
                        </div>
                    `).join('') : 
                    '<p style="color: #bdc3c7; font-style: italic;">No comments yet.</p>'
                }
            </div>
            <div>
                <textarea id="new-comment" rows="3" placeholder="Add admin comment..." 
                          style="width: 100%; background: #2c3e50; border: 1px solid #00ff88; color: white; padding: 10px; border-radius: 4px; margin-bottom: 10px;"></textarea>
                <button onclick="addComment(${boosterId})" 
                        style="background: #00ff88; color: #1a1a1a; border: none; padding: 8px 16px; border-radius: 4px; font-weight: bold; cursor: pointer;">
                    Add Comment
                </button>
            </div>
        </div>
    `;
}

function editBooster(boosterId) {
    // Redirect to Django admin for editing
    window.open(`/admin/booster/booster/${boosterId}/change/`, '_blank');
}

function setCommission(boosterId) {
    document.getElementById('booster-id').value = boosterId;
    const modal = document.getElementById('commissionModal');
    modal.style.display = 'block';
}

// Fallback modal function if Bootstrap modal doesn't work
function showSimpleModal(title, content) {
    // Create a simple modal overlay
    const overlay = document.createElement('div');
    overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
    `;
    
    const modal = document.createElement('div');
    modal.style.cssText = `
        background: #2c3e50;
        color: white;
        border: 1px solid #00ff88;
        border-radius: 8px;
        padding: 20px;
        max-width: 80%;
        max-height: 80%;
        overflow-y: auto;
        position: relative;
    `;
    
    modal.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #00ff88; padding-bottom: 10px;">
            <h3 style="color: #00ff88; margin: 0;">${title}</h3>
            <button onclick="this.closest('.modal-overlay').remove()" style="background: none; border: none; color: white; font-size: 1.5em; cursor: pointer;">&times;</button>
        </div>
        <div>${content}</div>
    `;
    
    overlay.className = 'modal-overlay';
    overlay.appendChild(modal);
    document.body.appendChild(overlay);
    
    // Close on overlay click
    overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
            overlay.remove();
        }
    });
}

function saveCommission() {
    const boosterId = document.getElementById('booster-id').value;
    const percentage = document.getElementById('commission-percentage').value;
    const notes = document.getElementById('commission-notes').value;
    
    if (!percentage || percentage < 0 || percentage > 100) {
        alert('Please enter a valid commission percentage (0-100)');
        return;
    }
    
    // Show loading state
    const button = event.target;
    const originalText = button.textContent;
    button.textContent = 'Saving...';
    button.disabled = true;
    
    // Save commission via AJAX
    fetch('/admin/dashboard/api/booster/commission/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify({
            booster_id: boosterId,
            percentage: percentage,
            notes: notes
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Commission set successfully!');
            closeCommissionModal();
            // Reload the booster details to show the new commission
            viewBoosterDetails(boosterId);
        } else {
            alert('Error setting commission: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error setting commission:', error);
        alert('Error setting commission');
    })
    .finally(() => {
        button.textContent = originalText;
        button.disabled = false;
    });
}

function deleteBooster(boosterId) {
    if (confirm('Are you sure you want to delete this booster? This action cannot be undone.')) {
        fetch(`/admin/dashboard/api/booster/${boosterId}/delete/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCSRFToken()
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Booster deleted successfully!');
                location.reload();
            } else {
                alert('Error deleting booster');
            }
        })
        .catch(error => {
            console.error('Error deleting booster:', error);
            alert('Error deleting booster');
        });
    }
}

function addComment(boosterId) {
    const comment = document.getElementById('new-comment').value;
    if (!comment.trim()) {
        alert('Please enter a comment');
        return;
    }
    
    // Show loading state
    const button = event.target;
    const originalText = button.textContent;
    button.textContent = 'Adding...';
    button.disabled = true;
    
    fetch('/admin/dashboard/api/booster/comment/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify({
            booster_id: boosterId,
            comment: comment
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('new-comment').value = '';
            // Reload the modal to show the new comment
            viewBoosterDetails(boosterId);
        } else {
            alert('Error adding comment: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error adding comment:', error);
        alert('Error adding comment');
    })
    .finally(() => {
        button.textContent = originalText;
        button.disabled = false;
    });
}

function getCSRFToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
}

// Add event listeners for modal closing
document.addEventListener('DOMContentLoaded', function() {
    // Close modals when clicking outside
    document.getElementById('boosterDetailsModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeBoosterModal();
        }
    });
    
    document.getElementById('commissionModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeCommissionModal();
        }
    });
    
    // Close modals with Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeBoosterModal();
            closeCommissionModal();
        }
    });
});
</script>
{% endblock %}


