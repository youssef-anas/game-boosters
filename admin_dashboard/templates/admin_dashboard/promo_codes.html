{% extends "admin/base_site.html" %}

{% block content %}
<div class="container-fluid" style="padding:16px;">
    <h1>Promo Codes</h1>

    <div style="background:#16171d;border:1px solid #2a2c35;border-radius:8px;padding:12px;color:#fff;margin-bottom:16px;">
        <form id="promo-form" onsubmit="return createPromo(event)" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
            <input class="vTextField" name="code" placeholder="Code (optional)" />
            <input class="vTextField" name="description" placeholder="Description" />
            <input class="vTextField" type="number" step="0.01" name="discount_amount" placeholder="Amount" required />
            <label style="display:flex;gap:6px;align-items:center;">
                <input type="checkbox" name="is_percent" /> Percent
            </label>
            <input class="vTextField" type="number" name="days_valid" value="30" min="1" max="365" />
            <button class="button default" type="submit">Generate</button>
        </form>
        <div id="promo-msg" style="margin-top:8px;color:#90ee90;display:none;"></div>
    </div>

    <div class="table-responsive">
        <style>
        .table.table-hover tbody tr:hover td,
        .table.table-hover tbody tr:hover th { color:#fff !important; }
        .table.table-hover tbody tr:hover { background: rgba(0,255,136,0.08) !important; }
        </style>
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>Code</th>
                    <th>Description</th>
                    <th>Discount</th>
                    <th>Expires</th>
                    <th>Active</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for p in promos %}
                <tr>
                    <td><code>{{ p.code }}</code></td>
                    <td>{{ p.description }}</td>
                    <td>
                        {% if p.is_percent %}{{ p.discount_amount }}%{% else %}${{ p.discount_amount }}{% endif %}
                    </td>
                    <td>{{ p.expiration_date }}</td>
                    <td>{{ p.is_active|yesno:"Yes,No" }}</td>
                    <td>
                        <button class="button" onclick="copyCode('{{ p.code }}')">Copy</button>
                        <button class="button delete-button" onclick="deletePromo('{{ p.code }}')">Delete</button>
                    </td>
                </tr>
                {% empty %}
                <tr><td colspan="6">No promo codes</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
async function createPromo(e){
    e.preventDefault();
    const form = document.getElementById('promo-form');
    const msg = document.getElementById('promo-msg');
    msg.style.display='none';
    const data = Object.fromEntries(new FormData(form).entries());
    data.is_percent = !!data.is_percent;
    try{
        const resp = await fetch('/admin/dashboard/api/promo/', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(data)});
        const d = await resp.json();
        if(!resp.ok || d.success === false){ throw new Error(d.error || 'Failed'); }
        msg.textContent = `Created: ${d.code}`; msg.style.display='block';
        setTimeout(()=> location.reload(), 600);
    }catch(err){ alert(err.message); }
    return false;
}
async function deletePromo(code){
    if(!confirm(`Delete promo ${code}?`)) return;
    try{
        const resp = await fetch('/admin/dashboard/api/promo/', {method:'DELETE', headers:{'Content-Type':'application/json'}, body: JSON.stringify({code})});
        const d = await resp.json();
        if(!resp.ok || d.success === false){ throw new Error(d.error || 'Failed'); }
        location.reload();
    }catch(err){ alert(err.message); }
}
function copyCode(code){ navigator.clipboard.writeText(code); alert('Copied'); }
</script>
{% endblock %}


