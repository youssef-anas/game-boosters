{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}Chat Monitor - MadBoost Admin{% endblock %}

{% block extrahead %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'admin/css/madboost-admin.css' %}">
{% endblock %}

{% block content %}
<div class="chat-monitor-container">
    <!-- Chat Monitor Header -->
    <div class="chat-monitor-header">
        <h1><i class="fas fa-comments"></i> Chat Monitoring Dashboard</h1>
        <div class="chat-summary">
            <div class="summary-item">
                <span class="summary-number">{{ total_chats }}</span>
                <span class="summary-label">Total Chat Rooms</span>
            </div>
            <div class="summary-item">
                <span class="summary-number">{{ active_chats }}</span>
                <span class="summary-label">Active Chats</span>
            </div>
            <div class="summary-item">
                <span class="summary-number">{{ total_messages }}</span>
                <span class="summary-label">Total Messages</span>
            </div>
            <div class="summary-item">
                <span class="summary-number">{{ recent_messages|length }}</span>
                <span class="summary-label">Recent Messages</span>
            </div>
        </div>
    </div>

    <!-- Chat Channels Row -->
    <div class="row">
        <div class="col-md-6">
            <div class="dashboard-widget">
                <div class="widget-header">
                    <h3 class="widget-title">
                        <i class="fas fa-user-friends"></i> Client-Booster Chat
                    </h3>
                    <div class="widget-controls">
                        <button class="btn btn-sm btn-primary" onclick="refreshClientBoosterChat()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                        <button class="btn btn-sm btn-success" onclick="exportClientBoosterChat()">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                </div>
                <div class="chat-channel-content">
                    <div class="chat-filters">
                        <select class="form-control form-control-sm" id="client-booster-filter">
                            <option value="">All Chat Rooms</option>
                            <option value="active">Active Only</option>
                            <option value="recent">Recent Activity</option>
                        </select>
                    </div>
                    <div class="chat-rooms-list" id="client-booster-rooms">
                        <!-- Chat rooms will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="dashboard-widget">
                <div class="widget-header">
                    <h3 class="widget-title">
                        <i class="fas fa-user-tie"></i> Manager-Booster Chat
                    </h3>
                    <div class="widget-controls">
                        <button class="btn btn-sm btn-primary" onclick="refreshManagerBoosterChat()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                        <button class="btn btn-sm btn-success" onclick="exportManagerBoosterChat()">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                </div>
                <div class="chat-channel-content">
                    <div class="chat-filters">
                        <select class="form-control form-control-sm" id="manager-booster-filter">
                            <option value="">All Chat Rooms</option>
                            <option value="active">Active Only</option>
                            <option value="recent">Recent Activity</option>
                        </select>
                    </div>
                    <div class="chat-rooms-list" id="manager-booster-rooms">
                        <!-- Chat rooms will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Live Chat Monitor -->
    <div class="row">
        <div class="col-md-12">
            <div class="dashboard-widget">
                <div class="widget-header">
                    <h3 class="widget-title">
                        <i class="fas fa-broadcast-tower"></i> Live Chat Monitor
                        <span class="live-indicator">
                            <span class="pulse"></span>
                            <span class="live-text">LIVE</span>
                        </span>
                    </h3>
                    <div class="widget-controls">
                        <button class="btn btn-sm btn-danger" onclick="stopMonitoring()">
                            <i class="fas fa-stop"></i> Stop
                        </button>
                        <button class="btn btn-sm btn-success" onclick="startMonitoring()">
                            <i class="fas fa-play"></i> Start
                        </button>
                    </div>
                </div>
                <div class="live-chat-container">
                    <div class="live-chat-filters">
                        <div class="row">
                            <div class="col-md-3">
                                <label>Channel</label>
                                <select class="form-control" id="live-channel-filter">
                                    <option value="all">All Channels</option>
                                    <option value="client-booster">Client-Booster</option>
                                    <option value="manager-booster">Manager-Booster</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label>User Type</label>
                                <select class="form-control" id="live-user-filter">
                                    <option value="all">All Users</option>
                                    <option value="client">Clients</option>
                                    <option value="booster">Boosters</option>
                                    <option value="manager">Managers</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label>Message Type</label>
                                <select class="form-control" id="live-message-filter">
                                    <option value="all">All Messages</option>
                                    <option value="text">Text</option>
                                    <option value="file">Files</option>
                                    <option value="system">System</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label>&nbsp;</label>
                                <button class="btn btn-primary btn-block" onclick="applyLiveFilters()">
                                    <i class="fas fa-filter"></i> Apply
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="live-chat-messages" id="live-chat-messages">
                        <!-- Live messages will appear here -->
                        <div class="no-messages">
                            <i class="fas fa-comments"></i>
                            <p>No live messages. Start monitoring to see real-time activity.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Messages -->
    <div class="row">
        <div class="col-md-12">
            <div class="dashboard-widget">
                <div class="widget-header">
                    <h3 class="widget-title">
                        <i class="fas fa-history"></i> Recent Messages
                    </h3>
                    <div class="widget-controls">
                        <button class="btn btn-sm btn-primary" onclick="loadMoreMessages()">
                            <i class="fas fa-plus"></i> Load More
                        </button>
                    </div>
                </div>
                <div class="recent-messages-list" id="recent-messages-list">
                    {% for message in recent_messages %}
                    <div class="message-item" data-message-id="{{ message.id }}">
                        <div class="message-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="message-content">
                            <div class="message-header">
                                <span class="message-user">{{ message.user.username }}</span>
                                <span class="message-time">{{ message.created_at|timesince }} ago</span>
                                <span class="message-channel">{{ message.chat_room }}</span>
                            </div>
                            <div class="message-text">{{ message.content|truncatechars:100 }}</div>
                        </div>
                        <div class="message-actions">
                            <button class="btn btn-sm btn-info" onclick="viewFullMessage({{ message.id }})">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-warning" onclick="flagMessage({{ message.id }})">
                                <i class="fas fa-flag"></i>
                            </button>
                        </div>
                    </div>
                    {% empty %}
                    <div class="no-messages">
                        <i class="fas fa-inbox"></i>
                        <p>No recent messages found</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chat Room Details Modal -->
<div class="modal fade" id="chatRoomModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Chat Room Details</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="chat-room-info">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Room Information</h6>
                            <div id="room-info-content">
                                <!-- Room info will be loaded here -->
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Participants</h6>
                            <div id="participants-content">
                                <!-- Participants will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="chat-messages-container">
                    <h6>Chat History</h6>
                    <div class="chat-messages" id="chat-messages-content">
                        <!-- Chat messages will be loaded here -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-warning" onclick="exportChatHistory()">
                    <i class="fas fa-download"></i> Export History
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Message Details Modal -->
<div class="modal fade" id="messageDetailsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Message Details</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body" id="message-details-content">
                <!-- Message details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-warning" onclick="flagMessage()">
                    <i class="fas fa-flag"></i> Flag Message
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Flag Message Modal -->
<div class="modal fade" id="flagMessageModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Flag Message</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="flagMessageForm">
                    <input type="hidden" id="flagged-message-id">
                    <div class="form-group">
                        <label>Flag Reason</label>
                        <select class="form-control" id="flag-reason" required>
                            <option value="">Select Reason</option>
                            <option value="inappropriate">Inappropriate Content</option>
                            <option value="spam">Spam</option>
                            <option value="harassment">Harassment</option>
                            <option value="scam">Scam/Fraud</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Additional Notes</label>
                        <textarea class="form-control" id="flag-notes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" onclick="submitFlag()">
                    <i class="fas fa-flag"></i> Submit Flag
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extrajs %}
{{ block.super }}
<script src="{% static 'admin/js/madboost-admin.js' %}"></script>
<script>
// Chat monitoring JavaScript
let monitoringActive = false;
let chatWebSocket = null;

document.addEventListener('DOMContentLoaded', function() {
    loadChatRooms();
    setupChatFilters();
});

function loadChatRooms() {
    // Load client-booster chat rooms
    loadClientBoosterRooms();
    
    // Load manager-booster chat rooms
    loadManagerBoosterRooms();
}

function loadClientBoosterRooms() {
    fetch('{% url "admin_dashboard:client_booster_chat" %}')
        .then(response => response.json())
        .then(data => {
            displayChatRooms('client-booster-rooms', data.rooms);
        })
        .catch(error => {
            console.log('Error loading client-booster rooms:', error);
        });
}

function loadManagerBoosterRooms() {
    fetch('{% url "admin_dashboard:manager_booster_chat" %}')
        .then(response => response.json())
        .then(data => {
            displayChatRooms('manager-booster-rooms', data.rooms);
        })
        .catch(error => {
            console.log('Error loading manager-booster rooms:', error);
        });
}

function displayChatRooms(containerId, rooms) {
    const container = document.getElementById(containerId);
    
    if (rooms.length === 0) {
        container.innerHTML = `
            <div class="no-chat-rooms">
                <i class="fas fa-comments"></i>
                <p>No chat rooms found</p>
            </div>
        `;
        return;
    }
    
    const roomsHtml = rooms.map(room => `
        <div class="chat-room-item" onclick="viewChatRoom('${room.id}')">
            <div class="room-header">
                <span class="room-name">${room.name}</span>
                <span class="room-status ${room.status}">${room.status}</span>
            </div>
            <div class="room-participants">
                <span class="participant">${room.participants.join(', ')}</span>
            </div>
            <div class="room-activity">
                <span class="last-message">${room.last_message || 'No messages'}</span>
                <span class="message-count">${room.message_count} messages</span>
            </div>
        </div>
    `).join('');
    
    container.innerHTML = roomsHtml;
}

function viewChatRoom(roomId) {
    fetch(`/admin/api/chat-room/${roomId}/`)
        .then(response => response.json())
        .then(data => {
            // Populate room info
            document.getElementById('room-info-content').innerHTML = `
                <p><strong>Room ID:</strong> ${data.id}</p>
                <p><strong>Room Type:</strong> ${data.type}</p>
                <p><strong>Status:</strong> ${data.status}</p>
                <p><strong>Created:</strong> ${data.created_at}</p>
                <p><strong>Last Activity:</strong> ${data.last_activity}</p>
            `;
            
            // Populate participants
            document.getElementById('participants-content').innerHTML = data.participants.map(participant => `
                <div class="participant-item">
                    <span class="participant-name">${participant.username}</span>
                    <span class="participant-role">${participant.role}</span>
                    <span class="participant-status ${participant.status}">${participant.status}</span>
                </div>
            `).join('');
            
            // Populate chat messages
            document.getElementById('chat-messages-content').innerHTML = data.messages.map(message => `
                <div class="chat-message">
                    <div class="message-user">${message.user.username}</div>
                    <div class="message-content">${message.content}</div>
                    <div class="message-time">${message.created_at}</div>
                </div>
            `).join('');
            
            $('#chatRoomModal').modal('show');
        })
        .catch(error => {
            console.log('Error loading chat room details:', error);
            showNotification('Error loading chat room details', 'error');
        });
}

function startMonitoring() {
    if (monitoringActive) return;
    
    monitoringActive = true;
    
    // Update UI
    document.querySelector('.live-indicator .live-text').textContent = 'LIVE';
    document.querySelector('.live-indicator').classList.add('active');
    
    // Start WebSocket connection
    startWebSocketConnection();
    
    // Start polling as fallback
    startPolling();
    
    showNotification('Chat monitoring started', 'success');
}

function stopMonitoring() {
    if (!monitoringActive) return;
    
    monitoringActive = false;
    
    // Update UI
    document.querySelector('.live-indicator .live-text').textContent = 'STOPPED';
    document.querySelector('.live-indicator').classList.remove('active');
    
    // Close WebSocket
    if (chatWebSocket) {
        chatWebSocket.close();
        chatWebSocket = null;
    }
    
    // Stop polling
    stopPolling();
    
    showNotification('Chat monitoring stopped', 'info');
}

function startWebSocketConnection() {
    try {
        chatWebSocket = new WebSocket('ws://localhost:8000/ws/chat-monitor/');
        
        chatWebSocket.onopen = function() {
            console.log('ðŸ”Œ Chat monitoring WebSocket connected');
        };
        
        chatWebSocket.onmessage = function(event) {
            const data = JSON.parse(event.data);
            handleLiveMessage(data);
        };
        
        chatWebSocket.onclose = function() {
            console.log('ðŸ”Œ Chat monitoring WebSocket disconnected');
            if (monitoringActive) {
                // Try to reconnect
                setTimeout(startWebSocketConnection, 5000);
            }
        };
    } catch (error) {
        console.log('WebSocket not available, using polling');
        startPolling();
    }
}

function startPolling() {
    // Poll for new messages every 5 seconds
    window.chatPollingInterval = setInterval(function() {
        if (monitoringActive) {
            fetchLiveMessages();
        }
    }, 5000);
}

function stopPolling() {
    if (window.chatPollingInterval) {
        clearInterval(window.chatPollingInterval);
        window.chatPollingInterval = null;
    }
}

function fetchLiveMessages() {
    fetch('/admin/api/live-messages/')
        .then(response => response.json())
        .then(data => {
            data.messages.forEach(message => {
                handleLiveMessage(message);
            });
        })
        .catch(error => {
            console.log('Error fetching live messages:', error);
        });
}

function handleLiveMessage(message) {
    // Add message to live chat container
    const liveContainer = document.getElementById('live-chat-messages');
    
    // Remove "no messages" placeholder if it exists
    const noMessages = liveContainer.querySelector('.no-messages');
    if (noMessages) {
        noMessages.remove();
    }
    
    // Create message element
    const messageElement = document.createElement('div');
    messageElement.className = 'live-message-item fade-in';
    messageElement.innerHTML = `
        <div class="message-avatar">
            <i class="fas fa-user"></i>
        </div>
        <div class="message-content">
            <div class="message-header">
                <span class="message-user">${message.user.username}</span>
                <span class="message-time">${message.created_at}</span>
                <span class="message-channel">${message.channel}</span>
            </div>
            <div class="message-text">${message.content}</div>
        </div>
        <div class="message-actions">
            <button class="btn btn-sm btn-info" onclick="viewFullMessage(${message.id})">
                <i class="fas fa-eye"></i>
            </button>
            <button class="btn btn-sm btn-warning" onclick="flagMessage(${message.id})">
                <i class="fas fa-flag"></i>
            </button>
        </div>
    `;
    
    // Add to container
    liveContainer.insertBefore(messageElement, liveContainer.firstChild);
    
    // Limit number of displayed messages
    const messages = liveContainer.querySelectorAll('.live-message-item');
    if (messages.length > 50) {
        messages[messages.length - 1].remove();
    }
    
    // Add notification sound
    playNotificationSound('chat');
}

function applyLiveFilters() {
    const channel = document.getElementById('live-channel-filter').value;
    const userType = document.getElementById('live-user-filter').value;
    const messageType = document.getElementById('live-message-filter').value;
    
    // Apply filters to live messages
    const messages = document.querySelectorAll('.live-message-item');
    messages.forEach(message => {
        let show = true;
        
        // Channel filter
        if (channel !== 'all') {
            const messageChannel = message.querySelector('.message-channel').textContent;
            if (messageChannel !== channel) show = false;
        }
        
        // User type filter
        if (userType !== 'all') {
            const messageUser = message.querySelector('.message-user').textContent;
            // This would need to be implemented based on your user system
        }
        
        // Message type filter
        if (messageType !== 'all') {
            const messageText = message.querySelector('.message-text').textContent;
            // This would need to be implemented based on your message system
        }
        
        message.style.display = show ? 'flex' : 'none';
    });
}

function viewFullMessage(messageId) {
    fetch(`/admin/api/message/${messageId}/`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('message-details-content').innerHTML = `
                <div class="message-details">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Message Information</h6>
                            <p><strong>ID:</strong> ${data.id}</p>
                            <p><strong>User:</strong> ${data.user.username}</p>
                            <p><strong>Channel:</strong> ${data.channel}</p>
                            <p><strong>Created:</strong> ${data.created_at}</p>
                        </div>
                        <div class="col-md-6">
                            <h6>Message Content</h6>
                            <div class="message-full-content">${data.content}</div>
                        </div>
                    </div>
                </div>
            `;
            
            $('#messageDetailsModal').modal('show');
        })
        .catch(error => {
            console.log('Error loading message details:', error);
            showNotification('Error loading message details', 'error');
        });
}

function flagMessage(messageId) {
    document.getElementById('flagged-message-id').value = messageId;
    $('#flagMessageModal').modal('show');
}

function submitFlag() {
    const messageId = document.getElementById('flagged-message-id').value;
    const reason = document.getElementById('flag-reason').value;
    const notes = document.getElementById('flag-notes').value;
    
    if (!reason) {
        showNotification('Please select a flag reason', 'warning');
        return;
    }
    
    const flagData = {
        message_id: messageId,
        reason: reason,
        notes: notes
    };
    
    fetch('/admin/api/flag-message/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify(flagData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Message flagged successfully!', 'success');
            $('#flagMessageModal').modal('hide');
            document.getElementById('flagMessageForm').reset();
        } else {
            showNotification('Error flagging message', 'error');
        }
    })
    .catch(error => {
        console.log('Error flagging message:', error);
        showNotification('Error flagging message', 'error');
    });
}

function refreshClientBoosterChat() {
    loadClientBoosterRooms();
    showNotification('Client-booster chat refreshed', 'info');
}

function refreshManagerBoosterChat() {
    loadManagerBoosterRooms();
    showNotification('Manager-booster chat refreshed', 'info');
}

function exportClientBoosterChat() {
    showNotification('Export feature coming soon!', 'info');
}

function exportManagerBoosterChat() {
    showNotification('Export feature coming soon!', 'info');
}

function exportChatHistory() {
    showNotification('Export feature coming soon!', 'info');
}

function loadMoreMessages() {
    showNotification('Load more feature coming soon!', 'info');
}

function setupChatFilters() {
    // Initialize chat filters
    document.getElementById('client-booster-filter').addEventListener('change', function() {
        filterChatRooms('client-booster-rooms', this.value);
    });
    
    document.getElementById('manager-booster-filter').addEventListener('change', function() {
        filterChatRooms('manager-booster-rooms', this.value);
    });
}

function filterChatRooms(containerId, filter) {
    const container = document.getElementById(containerId);
    const rooms = container.querySelectorAll('.chat-room-item');
    
    rooms.forEach(room => {
        let show = true;
        
        if (filter === 'active') {
            const status = room.querySelector('.room-status').textContent;
            show = status === 'active';
        } else if (filter === 'recent') {
            // This would need to be implemented based on your activity system
            show = true;
        }
        
        room.style.display = show ? 'block' : 'none';
    });
}

function playNotificationSound(type) {
    // Play notification sound for chat messages
    const audio = new Audio('/static/sounds/notification.wav');
    audio.volume = 0.3;
    audio.play().catch(error => {
        // Ignore audio errors
    });
}

function getCSRFToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
}

function showNotification(message, type) {
    if (window.MadBoostAdmin && window.MadBoostAdmin.showNotification) {
        window.MadBoostAdmin.showNotification(message, type);
    } else {
        alert(message);
    }
}
</script>
{% endblock %} 