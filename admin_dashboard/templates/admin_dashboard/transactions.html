{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}Transactions - MadBoost Admin{% endblock %}

{% block extrahead %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
.transactions-container {
    padding: 20px;
}
.dashboard-widget {
    background: #2c3e50;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    color: white;
}
.widget-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}
.widget-title {
    color: #00ff88;
    margin: 0;
}
.chart-container {
    position: relative;
    height: 300px;
    width: 100%;
}
#revenue-trends-chart, #game-revenue-chart {
    height: 300px !important;
    width: 100% !important;
}
.transactions-summary {
    display: flex;
    gap: 20px;
    margin: 20px 0;
}
.summary-item {
    text-align: center;
    padding: 15px;
    background: #34495e;
    border-radius: 8px;
    min-width: 150px;
}
.summary-number {
    display: block;
    font-size: 1.5em;
    font-weight: bold;
    color: #00ff88;
}
.summary-label {
    display: block;
    font-size: 0.9em;
    color: #bdc3c7;
    margin-top: 5px;
}
/* Improve row hover readability */
.table.table-hover tbody tr:hover td,
.table.table-hover tbody tr:hover th { color: #fff !important; }
.table.table-hover tbody tr:hover { background: rgba(0,255,136,0.08) !important; }
</style>
{% endblock %}

{% block content %}
<div class="transactions-container">
    <!-- Transactions Header -->
    <div class="transactions-header">
        <h1><i class="fas fa-money-bill-wave"></i> Transaction Management</h1>
        <div class="transactions-summary">
            <div class="summary-item">
                <span class="summary-number">${{ total_revenue|floatformat:2 }}</span>
                <span class="summary-label">Total Revenue</span>
            </div>
            <div class="summary-item">
                <span class="summary-number">{{ total_transactions }}</span>
                <span class="summary-label">Total Transactions</span>
            </div>
            <div class="summary-item">
                <span class="summary-number">${{ today_revenue|floatformat:2 }}</span>
                <span class="summary-label">Today's Revenue</span>
            </div>
            <div class="summary-item">
                <span class="summary-number">${{ month_revenue|floatformat:2 }}</span>
                <span class="summary-label">This Month</span>
            </div>
        </div>
    </div>

    <!-- Revenue Analytics Row -->
    <div class="row">
        <div class="col-md-8">
            <div class="dashboard-widget">
                <div class="widget-header">
                    <h3 class="widget-title">Revenue Trends</h3>
                    <div class="widget-controls">
                        <select class="form-control form-control-sm" id="revenue-period">
                            <option value="7">Last 7 Days</option>
                            <option value="30" selected>Last 30 Days</option>
                            <option value="90">Last 90 Days</option>
                        </select>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="revenue-trends-chart"></canvas>
                    <!-- Fallback table if chart fails -->
                    <div id="trends-table" style="display: none; color: white;">
                        <table class="table table-dark">
                            <thead>
                                <tr>
                                    <th>Month</th>
                                    <th>Revenue</th>
                                    <th>Trend</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td>Jan</td><td>$12,000</td><td><div style="background: #00ff88; height: 20px; width: 12px;"></div></td></tr>
                                <tr><td>Feb</td><td>$19,000</td><td><div style="background: #00ff88; height: 20px; width: 19px;"></div></td></tr>
                                <tr><td>Mar</td><td>$15,000</td><td><div style="background: #00ff88; height: 20px; width: 15px;"></div></td></tr>
                                <tr><td>Apr</td><td>$25,000</td><td><div style="background: #00ff88; height: 20px; width: 25px;"></div></td></tr>
                                <tr><td>May</td><td>$22,000</td><td><div style="background: #00ff88; height: 20px; width: 22px;"></div></td></tr>
                                <tr><td>Jun</td><td>$30,000</td><td><div style="background: #00ff88; height: 20px; width: 30px;"></div></td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="dashboard-widget">
                <div class="widget-header">
                    <h3 class="widget-title">Revenue by Game</h3>
                    <i class="widget-icon fas fa-chart-pie"></i>
                </div>
                <div class="chart-container" style="height: 200px;">
                    <canvas id="game-revenue-chart"></canvas>
                    <!-- Fallback list if chart fails -->
                    <div id="game-list" style="display: none; color: white;">
                        <ul style="list-style: none; padding: 0;">
                            <li style="margin: 10px 0;"><span style="background: #00ff88; width: 20px; height: 20px; display: inline-block; margin-right: 10px;"></span>CS:GO - 35%</li>
                            <li style="margin: 10px 0;"><span style="background: #ff0080; width: 20px; height: 20px; display: inline-block; margin-right: 10px;"></span>Dota 2 - 25%</li>
                            <li style="margin: 10px 0;"><span style="background: #0080ff; width: 20px; height: 20px; display: inline-block; margin-right: 10px;"></span>LoL - 20%</li>
                            <li style="margin: 10px 0;"><span style="background: #ff8000; width: 20px; height: 20px; display: inline-block; margin-right: 10px;"></span>Valorant - 15%</li>
                            <li style="margin: 10px 0;"><span style="background: #8000ff; width: 20px; height: 20px; display: inline-block; margin-right: 10px;"></span>Other - 5%</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Transaction Filters -->
    <div class="filters-section">
        <form method="get">
        <div class="row">
            <div class="col-md-3">
                <label>Date From</label>
                <input type="date" class="form-control" id="date-from" name="date_from" value="{{ request.GET.date_from }}">
            </div>
            <div class="col-md-3">
                <label>Date To</label>
                <input type="date" class="form-control" id="date-to" name="date_to" value="{{ request.GET.date_to }}">
            </div>
            <div class="col-md-2">
                <label>Status</label>
                <select class="form-control" id="status-filter" name="status">
                    <option value="">All Status</option>
                    <option value="Done">Done</option>
                    <option value="New">New</option>
                    <option value="Drop">Drop</option>
                    <option value="Extend">Extend</option>
                    <option value="Tip">Tip</option>
                </select>
            </div>
            <div class="col-md-2">
                <label>Transaction Type</label>
                <select class="form-control" id="type-filter" name="type">
                    <option value="">All Types</option>
                    <option value="DEPOSIT">DEPOSIT</option>
                    <option value="WITHDRAWAL">WITHDRAWAL</option>
                </select>
            </div>
            <div class="col-md-2">
                <label>&nbsp;</label>
                <button type="submit" class="btn btn-primary btn-block">
                    <i class="fas fa-filter"></i> Filter
                </button>
            </div>
        </div>
        </form>
    </div>

    <!-- Transactions Table -->
    <div class="table-responsive">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>Transaction ID</th>
                    <th>Client</th>
                    <th>Order</th>
                    <th>Amount</th>
                    <th>Payment Method</th>
                    <th>Status</th>
                    <th>Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="transactions-table-body">
                {% for transaction in transactions %}
                <tr data-transaction-id="{{ transaction.id }}">
                    <td>
                        <span class="transaction-id">{{ transaction.id }}</span>
                    </td>
                    <td>
                        <div class="client-info">
                            <div class="client-name">{{ transaction.user.username }}</div>
                            <div class="client-email">{{ transaction.user.email }}</div>
                        </div>
                    </td>
                    <td>
                        {% if transaction.order %}
                        <a href="#" onclick="viewOrderDetails({{ transaction.order.id }})" class="order-link">
                            Order #{{ transaction.order.id }}
                        </a>
                        {% else %}
                        <span class="text-muted">No Order</span>
                        {% endif %}
                    </td>
                    <td>
                        <span class="amount">${{ transaction.amount|floatformat:2 }}</span>
                    </td>
                    <td>
                        <span class="payment-method">
                            <i class="fas fa-credit-card"></i>
                            {{ transaction.type|default:"N/A" }}
                        </span>
                    </td>
                    <td>
                        <span class="badge badge-{{ transaction.status|lower }}">{{ transaction.status }}</span>
                    </td>
                    <td>
                        <span class="transaction-date">{{ transaction.date|date:"M d, Y H:i" }}</span>
                    </td>
                    <td>
                        <div class="transaction-actions">
                            <button class="btn btn-sm btn-info" onclick="viewTransactionDetails({{ transaction.id }})">
                                <i class="fas fa-eye"></i>
                            </button>
                            {% if transaction.status == 'Done' %}
                            <button class="btn btn-sm btn-warning" onclick="initiateRefund({{ transaction.id }})">
                                <i class="fas fa-undo"></i>
                            </button>
                            {% endif %}
                            <button class="btn btn-sm btn-danger" onclick="deleteTransaction({{ transaction.id }})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="8" class="text-center">
                        <div class="no-data">
                            <i class="fas fa-inbox"></i>
                            <p>No transactions found</p>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    {% if is_paginated %}
    <nav aria-label="Transaction pagination">
        <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}">Previous</a>
            </li>
            {% endif %}
            
            {% for num in page_obj.paginator.page_range %}
            <li class="page-item {% if page_obj.number == num %}active{% endif %}">
                <a class="page-link" href="?page={{ num }}">{{ num }}</a>
            </li>
            {% endfor %}
            
            {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}">Next</a>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
</div>

<!-- Transaction Details Modal -->
<div id="transactionDetailsModal" tabindex="-1" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:1000;">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Transaction Details</h5>
                <button type="button" class="close" onclick="closeModal('transactionDetailsModal')">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body" id="transaction-details-content">
                <!-- Transaction details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('transactionDetailsModal')">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Refund Modal -->
<div id="refundModal" tabindex="-1" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:1000;">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Initiate Refund</h5>
                <button type="button" class="close" onclick="closeModal('refundModal')">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="refundForm">
                    <input type="hidden" id="refund-transaction-id">
                    <div class="form-group">
                        <label>Transaction Amount</label>
                        <input type="text" class="form-control" id="refund-amount" readonly>
                    </div>
                    <div class="form-group">
                        <label>Refund Amount</label>
                        <input type="number" class="form-control" id="refund-amount-input" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>Refund Reason</label>
                        <select class="form-control" id="refund-reason" required>
                            <option value="">Select Reason</option>
                            <option value="customer_request">Customer Request</option>
                            <option value="service_issue">Service Issue</option>
                            <option value="payment_error">Payment Error</option>
                            <option value="duplicate_charge">Duplicate Charge</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Additional Notes</label>
                        <textarea class="form-control" id="refund-notes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('refundModal')">Cancel</button>
                <button type="button" class="btn btn-warning" onclick="processRefund()">Process Refund</button>
            </div>
        </div>
    </div>
</div>

<!-- Order Details Modal -->
<div id="orderDetailsModal" tabindex="-1" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:1000;">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Order Details</h5>
                <button type="button" class="close" onclick="closeModal('orderDetailsModal')">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body" id="order-details-content">
                <!-- Order details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('orderDetailsModal')">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extrajs %}
{{ block.super }}
<script>
// Transactions management JavaScript
document.addEventListener('DOMContentLoaded', function() {
    initializeTransactionCharts();
    setupTransactionFilters();
});
function openModal(id){ const el=document.getElementById(id); if(el){ el.style.display='block'; }}
function closeModal(id){ const el=document.getElementById(id); if(el){ el.style.display='none'; }}

function initializeTransactionCharts() {
    console.log('Initializing transaction charts...');
    
    // Check if Chart.js is loaded
    if (typeof Chart === 'undefined') {
        console.error('Chart.js is not loaded! Using fallback tables.');
        showTransactionFallbackTables();
        return;
    }
    
    let chartSuccess = false;
    
    // Try Revenue Trends Chart
    const trendsCtx = document.getElementById('revenue-trends-chart');
    if (trendsCtx) {
        try {
            new Chart(trendsCtx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    datasets: [{
                        label: 'Revenue',
                        data: [12000, 19000, 15000, 25000, 22000, 30000],
                        borderColor: '#00ff88',
                        backgroundColor: 'rgba(0, 255, 136, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true },
                        x: { }
                    }
                }
            });
            console.log('Revenue trends chart created successfully');
            chartSuccess = true;
        } catch (error) {
            console.error('Error creating trends chart:', error);
        }
    }

    // Try Game Revenue Chart
    const gameCtx = document.getElementById('game-revenue-chart');
    if (gameCtx) {
        try {
            new Chart(gameCtx, {
                type: 'doughnut',
                data: {
                    labels: ['CS:GO', 'Dota 2', 'LoL', 'Valorant', 'Other'],
                    datasets: [{
                        data: [35, 25, 20, 15, 5],
                        backgroundColor: ['#00ff88', '#ff0080', '#0080ff', '#ff8000', '#8000ff']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
            console.log('Game revenue chart created successfully');
        } catch (error) {
            console.error('Error creating game chart:', error);
        }
    }
    
    // If charts failed, show fallback tables after 2 seconds
    if (!chartSuccess) {
        setTimeout(showTransactionFallbackTables, 2000);
    }
}

function showTransactionFallbackTables() {
    console.log('Showing transaction fallback tables...');
    const trendsTable = document.getElementById('trends-table');
    const gameList = document.getElementById('game-list');
    
    if (trendsTable) {
        trendsTable.style.display = 'block';
        document.getElementById('revenue-trends-chart').style.display = 'none';
    }
    
    if (gameList) {
        gameList.style.display = 'block';
        document.getElementById('game-revenue-chart').style.display = 'none';
    }
}

function setupTransactionFilters() {
    // Set default date range (last 30 days)
    const today = new Date();
    const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
    
    document.getElementById('date-from').value = thirtyDaysAgo.toISOString().split('T')[0];
    document.getElementById('date-to').value = today.toISOString().split('T')[0];
}

function applyTransactionFilters() {
    const filters = {
        date_from: document.getElementById('date-from').value,
        date_to: document.getElementById('date-to').value,
        status: document.getElementById('status-filter').value,
        type: document.getElementById('type-filter').value
    };
    
    // Reload page with filters to let the server render the list
    const queryString = new URLSearchParams(filters).toString();
    const baseUrl = window.location.pathname;
    window.location.href = `${baseUrl}?${queryString}`;
}

function loadTransactionsWithFilters() {}

function viewTransactionDetails(transactionId) {
    fetch(`/admin/dashboard/api/transaction/${transactionId}/`)
        .then(async (response) => {
            const text = await response.text();
            let data = null;
            try { data = JSON.parse(text); } catch (e) { /* not JSON */ }
            return { ok: response.ok, data, text };
        })
        .then(({ ok, data, text }) => {
            const content = document.getElementById('transaction-details-content');
            if (content) { content.style.color = '#111'; }
            if(!ok){
                content.innerHTML = `<div style="color:#ff7070;">Failed to load (status ${ok}).</div>`;
                openModal('transactionDetailsModal');
                return;
            }
            if(!data){
                content.innerHTML = `<div style=\"color:#ff7070;\">Unexpected response:<br><pre style=\"white-space:pre-wrap;\">${text}</pre></div>`;
                openModal('transactionDetailsModal');
                return;
            }
            content.innerHTML = `
                <div class="transaction-details">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Transaction Information</h6>
                            <p><strong>ID:</strong> ${data.id}</p>
                            <p><strong>Amount:</strong> $${data.amount}</p>
                            <p><strong>Status:</strong> ${data.status}</p>
                            <p><strong>Payment Method:</strong> ${data.payment_method}</p>
                            <p><strong>Created:</strong> ${data.created_at}</p>
                        </div>
                        <div class="col-md-6">
                            <h6>Client Information</h6>
                            <p><strong>Username:</strong> ${data.user.username}</p>
                            <p><strong>Email:</strong> ${data.user.email}</p>
                            <p><strong>Total Spent:</strong> $${data.user.total_spent || 0}</p>
                        </div>
                    </div>
                    ${data.order ? `
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6>Order Information</h6>
                            <p><strong>Order ID:</strong> ${data.order.id}</p>
                            <p><strong>Game:</strong> ${data.order.game}</p>
                            <p><strong>Service:</strong> ${data.order.service_type}</p>
                            <p><strong>Status:</strong> ${data.order.status}</p>
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;
            
            openModal('transactionDetailsModal');
        })
        .catch(error => {
            console.log('Error loading transaction details:', error);
            showNotification('Error loading transaction details', 'error');
            const content = document.getElementById('transaction-details-content');
            if(content){ content.innerHTML = '<div style="color:#ff7070;">Failed to load details.</div>'; openModal('transactionDetailsModal'); }
        });
}

function viewOrderDetails(orderId) {
    fetch(`/admin/dashboard/api/order/${orderId}/`)
        .then(async (response) => {
            const text = await response.text();
            let data = null; try { data = JSON.parse(text); } catch(e) {}
            return { ok: response.ok, data, text };
        })
        .then(({ ok, data, text }) => {
            const content = document.getElementById('order-details-content');
            if (content) { content.style.color = '#111'; }
            if(!ok){
                content.innerHTML = '<div style="color:#ff7070;">Failed to load order.</div>';
                openModal('orderDetailsModal');
                return;
            }
            if(!data){
                content.innerHTML = `<div style=\"color:#ff7070;\">Unexpected response:<br><pre style=\"white-space:pre-wrap;\">${text}</pre></div>`;
                openModal('orderDetailsModal');
                return;
            }
            content.innerHTML = `
                <div class="order-details">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Order Information</h6>
                            <p><strong>ID:</strong> ${data.id}</p>
                            <p><strong>Game:</strong> ${data.game}</p>
                            <p><strong>Service:</strong> ${data.service_type}</p>
                            <p><strong>Status:</strong> ${data.status}</p>
                            <p><strong>Total Amount:</strong> $${data.total_amount}</p>
                        </div>
                        <div class="col-md-6">
                            <h6>Client Information</h6>
                            <p><strong>Username:</strong> ${data.customer.username}</p>
                            <p><strong>Email:</strong> ${data.customer.email}</p>
                            <p><strong>Created:</strong> ${data.created_at}</p>
                        </div>
                    </div>
                </div>
            `;
            
            openModal('orderDetailsModal');
        })
        .catch(error => {
            console.log('Error loading order details:', error);
            showNotification('Error loading order details', 'error');
            const content = document.getElementById('order-details-content');
            if(content){ content.innerHTML = '<div style="color:#ff7070;">Failed to load order details.</div>'; openModal('orderDetailsModal'); }
        });
}

function initiateRefund(transactionId) {
    // Get transaction details
    fetch(`/admin/dashboard/api/transaction/${transactionId}/`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('refund-transaction-id').value = transactionId;
            document.getElementById('refund-amount').value = `$${data.amount}`;
            document.getElementById('refund-amount-input').value = data.amount;
            document.getElementById('refund-amount-input').max = data.amount;
            
            openModal('refundModal');
        })
        .catch(error => {
            console.log('Error loading transaction for refund:', error);
            showNotification('Error loading transaction details', 'error');
        });
}

function processRefund() {
    const transactionId = document.getElementById('refund-transaction-id').value;
    const refundAmount = document.getElementById('refund-amount-input').value;
    const refundReason = document.getElementById('refund-reason').value;
    const refundNotes = document.getElementById('refund-notes').value;
    
    if (!refundReason) {
        showNotification('Please select a refund reason', 'warning');
        return;
    }
    
    const refundData = {
        transaction_id: transactionId,
        amount: refundAmount,
        reason: refundReason,
        notes: refundNotes
    };
    
    fetch('/admin/dashboard/api/refund/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify(refundData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Refund processed successfully!', 'success');
            $('#refundModal').modal('hide');
            window.location.reload();
        } else {
            showNotification('Error processing refund', 'error');
        }
    })
    .catch(error => {
        console.log('Error processing refund:', error);
        showNotification('Error processing refund', 'error');
    });
}

function deleteTransaction(transactionId) {
    if (confirm('Are you sure you want to delete this transaction? This action cannot be undone.')) {
        fetch(`/admin/dashboard/api/delete/transaction/${transactionId}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCSRFToken()
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Transaction deleted successfully!', 'success');
                // Remove row from table
                document.querySelector(`[data-transaction-id="${transactionId}"]`).remove();
            } else {
                showNotification('Error deleting transaction', 'error');
            }
        })
        .catch(error => {
            console.log('Error deleting transaction:', error);
            showNotification('Error deleting transaction', 'error');
        });
    }
}

function getCSRFToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
}

function showNotification(message, type) {
    if (window.MadBoostAdmin && window.MadBoostAdmin.showNotification) {
        window.MadBoostAdmin.showNotification(message, type);
    } else {
        alert(message);
    }
}
</script>
{% endblock %} 